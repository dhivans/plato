name: Build Plato for Kobo (arm-unknown-linux-gnueabihf)

on:
  push:
    branches: ["**"]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git cmake pkg-config \
            wget unzip zip tar xz-utils \
            libfreetype6-dev zlib1g-dev libzip-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf

      - name: Install Rust + target
        uses: dtolnay/rust-toolchain@stable
      - run: rustup target add arm-unknown-linux-gnueabihf

      # Your build.sh downloads prebuilt libs & builds everything for Kobo
      - name: Build (uses default 'fast' method)
        run: bash ./build.sh

      # Package the app exactly how the Kobo expects it under .adds/plato/
      - name: Package .adds/plato
        shell: bash
        run: |
          set -euxo pipefail
          OUT=dist/.adds/plato
          rm -rf dist && mkdir -p "$OUT"

          # Runtime assets
          cp -a css icons fonts keyboard-layouts "$OUT"/

          # Launcher / scripts if present
          if [ -f plato.sh ]; then cp plato.sh "$OUT"/; fi
          if [ -d scripts ]; then cp -a scripts "$OUT"/; fi

          # Shared libs that build.sh downloaded/linked against
          if [ -d libs ]; then cp -a libs "$OUT"/; fi

          # Built Kobo binary
          BIN="target/arm-unknown-linux-gnueabihf/release/plato"
          if [ ! -f "$BIN" ]; then
            echo "Binary not found at $BIN"; ls -al target || true; exit 1
          fi
          install -m 0755 "$BIN" "$OUT/plato"

          # Create drop-in zip for device root
          (cd dist && zip -r plato-kobo.zip .adds)
          unzip -l dist/plato-kobo.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plato-kobo
          path: dist/plato-kobo.zip
